<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marketing Issues Draft | ãƒªã‚¢ãƒ«æ–½è¨­å‘ã‘ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° èª²é¡Œä»®èª¬ãƒ»æ–½ç­–ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆ</title>

  <!-- Markdown renderer (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      /* Friendly JP SaaS theme */
      --bg:#ffffff;
      --panel:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --muted2:#64748b;
      --line:rgba(15,23,42,.10);
      --shadow: 0 14px 42px rgba(15,23,42,.08);
      --shadow2: 0 10px 22px rgba(15,23,42,.06);
      --radius: 18px;
      --radius2: 22px;
      --radius3: 28px;

      --accent:#2563eb;
      --accent2:#60a5fa;
      --ok:#10b981;

      --soft:#eef2ff;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      background: var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none; }

    .wrap{ max-width:980px; margin:0 auto; padding:0 18px; }

    /* ===== Nav ===== */
    .nav{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .navInner{
      display:flex; align-items:center; justify-content:space-between;
      height:68px;
      gap:12px;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:42px; height:42px; border-radius:16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 26px rgba(37,99,235,.18);
      position:relative;
      flex: 0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:12px;
      border-radius:12px;
      background: #ffffff;
    }
    .brandText{ min-width:0; }
    .brandText .name{
      font-size:14px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      letter-spacing:.1px;
    }
    .brandText .tag{
      font-size:11px;
      color: var(--muted2);
      font-weight:800;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .navLinks{
      display:flex; align-items:center; gap:14px;
      color: var(--muted2);
      font-size:13px;
      font-weight:800;
    }
    .navLinks a{ padding:8px 10px; border-radius: 999px; }
    .navLinks a:hover{ color:var(--text); background: rgba(37,99,235,.06); }

    .navCta{ display:flex; align-items:center; gap:10px; }

    @media (max-width: 920px){
      .navLinks{ display:none; }
    }

    /* ===== Buttons ===== */
    .btn{
      border:none;
      padding:12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: .15s transform, .15s opacity, .15s box-shadow;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btnPrimary{
      background: linear-gradient(135deg, var(--accent), #1d4ed8);
      color:#fff;
      box-shadow: 0 12px 26px rgba(37,99,235,.22);
    }
    .btnGhost{
      background: #fff;
      border:1px solid var(--line);
      color: var(--text);
    }
    .btnSoft{
      background: rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.15);
      color: #1d4ed8;
    }
    .btnSmall{ padding:10px 12px; border-radius:14px; font-size:12px; }

    /* ===== Cards ===== */
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(37,99,235,.07), rgba(96,165,250,.04));
    }
    .cardHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:950;
    }
    .cardHeader span{ color:var(--muted2); font-size:12px; font-weight:800; }
    .cardBody{ padding:14px 14px; }

    /* ===== Hero ===== */
    .hero{ padding: 12px 0 6px; }
    .heroCard{ border-radius: var(--radius3); }
    .heroCard .cardBody{ padding:20px 18px 18px; }

    .kicker{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      color: var(--muted2);
      font-size:12px;
      font-weight:900;
      width:fit-content;
      box-shadow: var(--shadow2);
    }
    .kdot{
      width:10px; height:10px; border-radius:999px;
      background: var(--ok);
      box-shadow: 0 0 0 6px rgba(16,185,129,.12);
    }

    h1{
      margin:10px 0 8px;
      font-size:34px;
      line-height:1.16;
      letter-spacing:-.4px;
    }
    @media (max-width: 520px){
      h1{ font-size:30px; }
    }

    .sub{
      margin:0;
      color: rgba(15,23,42,.82);
      line-height:1.75;
      font-size:14px;
      max-width: 66ch;
    }

    .heroCtas{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
      align-items:center;
    }

    .note{
      margin-top:10px;
      color: var(--muted2);
      font-size:12px;
      line-height:1.6;
    }

    /* ===== Bullet cards (3 across) ===== */
    .bullets{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:14px;
    }
    @media (max-width: 820px){
      .bullets{ grid-template-columns: 1fr; }
    }

    .bullet{
      display:flex;
      gap:10px;
      padding:10px 10px;
      border-radius: 18px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow2);
      align-items:flex-start;
    }
    .icon{
      width:38px; height:38px;
      border-radius:16px;
      background: rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.14);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .bullet b{ display:block; font-size:13px; margin:0; font-weight:950; }
    .bullet p{ margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.55; }

    /* ===== Sections / Layout ===== */
    .section{ padding: 6px 0; }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .twoCol{ grid-template-columns: 1fr; }
    }

    @media (max-width: 980px){
      .resultBox{ height: 52vh; min-height: 320px; }
    }

    /* ===== Form ===== */
    label{
      display:block;
      font-size:12px;
      color: var(--muted2);
      margin:10px 0 8px;
      font-weight:950;
    }

    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      color: var(--text);
      line-height:1.6;
      font-size:13px;
      box-shadow: 0 8px 18px rgba(15,23,42,.03) inset;
    }

    input:focus, textarea:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 6px rgba(37,99,235,.12);
    }

    textarea{ min-height:110px; resize: vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }

    .help{
      font-size:12px;
      color: var(--muted);
      line-height:1.6;
      margin-top:10px;
    }

    /* ===== Result ===== */
    .status{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius: 16px;
      background:#f8fafc;
      margin-bottom:12px;
    }
    .statusLeft{ display:flex; align-items:center; gap:10px; min-width:0; }

    .spinner{
      width:18px; height:18px; border-radius:999px;
      border:2px solid rgba(15,23,42,.18);
      border-top-color: var(--accent);
      animation: spin .9s linear infinite;
      display:none;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .statusText{
      font-size:12px;
      color: var(--muted);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight:800;
    }

    .resultBox{
      padding:16px 16px;
      border-radius: 18px;
      border:1px solid var(--line);
      background:#fff;
      /* å‡ºåŠ›ãŒé•·ã„å ´åˆã§ã‚‚ã€Œé€”ä¸­ã§è¦‹åˆ‡ã‚Œãªã„ã€ã‚ˆã†ã«ã€ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã‚’è‡ªå‹•ä¼¸é•·ã•ã›ã¾ã™ï¼ˆãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§æœ€å¾Œã¾ã§é–²è¦§å¯èƒ½ï¼‰ */
      height:auto;
      max-height:none;
      overflow:visible;
      box-shadow: var(--shadow2);
    }

    /* ===== Copy / Selection (Google Sites embed friendly) ===== */
    .resultBox, .md, .md *{
      user-select: text;
      -webkit-user-select: text;
      -ms-user-select: text;
    }

    /* ===== Copy modal ===== */
    .copyModal{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .copyModalInner{
      width: min(920px, 96vw);
      max-height: 88vh;
      background: #ffffff;
      border: 1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .copyModalHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(37,99,235,.07), rgba(96,165,250,.04));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .copyModalTitle{
      font-weight:950;
      font-size:13px;
      letter-spacing:.2px;
    }
    .copyModalBody{
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .copyHint{
      font-size:12px;
      color: var(--muted2);
      line-height:1.6;
    }
    .copyArea{
      width:100%;
      min-height: 46vh;
      resize: vertical;
      border-radius: 14px;
      border:1px solid var(--line);
      padding:12px 12px;
      font-size:12px;
      line-height:1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      box-shadow: 0 8px 18px rgba(15,23,42,.03) inset;
    }

    /* ===== Markdown theme ===== */
    .md h1,.md h2,.md h3{ margin: 14px 0 10px; }
    .md h1{ font-size:18px; }
    .md h2{ font-size:16px; }
    .md h3{ font-size:14px; }
    .md p{ margin: 10px 0; color: rgba(15,23,42,.92); }
    .md ul{ margin: 10px 0 10px 20px; }
    .md li{ margin: 6px 0; }
    .md hr{ border:0; border-top:1px solid var(--line); margin: 14px 0; }
    .md code{
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.12);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .md pre{
      padding: 12px 12px;
      border-radius: 14px;
      background: #0b1220;
      color: #eaf0ff;
      border:1px solid rgba(15,23,42,.10);
      overflow:auto;
    }
    .md pre code{ border:none; background: transparent; padding:0; color:inherit; }
    .md table{
      width:100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size:12px;
    }
    .md th,.md td{
      border:1px solid var(--line);
      padding:10px 10px;
      vertical-align: top;
    }
    .md th{ background: rgba(37,99,235,.06); color: rgba(15,23,42,.95); text-align:left; }
    .md a{ color: var(--accent); }

    /* ===== Pricing ===== */
    .pricing{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .pricing{ grid-template-columns: 1fr; }
    }

    .priceCard{ box-shadow:none; border:1px solid var(--line); }

    .priceCard .cardBody{ padding:12px 12px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:999px;
      background: rgba(16,185,129,.10);
      color: #065f46;
      border:1px solid rgba(16,185,129,.20);
      font-size:11px;
      font-weight:950;
      width:fit-content;
      box-shadow: var(--shadow2);
    }
    .pillSoft{ background: var(--soft); border-color:#c7d2fe; color:#1d4ed8; }

    .price{
      font-size:22px;
      font-weight:980;
      margin:4px 0 4px;
      letter-spacing:-.3px;
    }
    .price small{ font-size:12px; color:var(--muted2); font-weight:900; }

    .list{
      margin: 6px 0 0 18px;
      color: rgba(15,23,42,.86);
      font-size:12px;
      line-height:1.55;
    }
    .list li{ margin:4px 0; }

    .softNote{
      font-size:12px;
      color: var(--muted2);
      line-height:1.6;
      margin-top:10px;
    }

    /* ===== Feedback ===== */
    .callout{
      padding:12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(37,99,235,.18);
      background: rgba(37,99,235,.06);
      color: rgba(15,23,42,.92);
      box-shadow: var(--shadow2);
    }
    .callout b{ display:flex; align-items:center; gap:8px; font-weight:950; }
    .callout p{ margin:8px 0 0; color: rgba(15,23,42,.78); font-size:12px; line-height:1.6; }

    .footer{
      padding: 22px 0 30px;
      color: var(--muted);
      font-size:12px;
      text-align:center;
      border-top: 1px solid var(--line);
      margin-top: 12px;
      background: #ffffff;
    }
    .footer a{ color: var(--accent); font-weight:950; }
  </style>
</head>

<body>
  <!-- NAV -->
  <header class="nav">
    <div class="wrap">
      <div class="navInner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brandText">
            <div class="name">Marketing Issues Draft</div>
            <div class="tag">ãƒªã‚¢ãƒ«æ–½è¨­å‘ã‘ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° èª²é¡Œä»®èª¬ãƒ»æ–½ç­–ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆ</div>
          </div>
        </div>

        <nav class="navLinks" aria-label="ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯">
          <a href="#how">ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆæ‰‹é †</a>
          <a href="#users">æƒ³å®šåˆ©ç”¨è€…</a>
          <a href="#pricing">æ–™é‡‘</a>
        </nav>

        <div class="navCta">
          <a class="btn btnSoft" href="#feedback">ğŸ“ è¦æœ›ãƒ•ã‚©ãƒ¼ãƒ </a>
          <a class="btn btnPrimary" href="#trial">ğŸš€ ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«</a>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- HERO -->
    <section class="hero" aria-label="ãƒ’ãƒ¼ãƒ­ãƒ¼">
      <div class="card heroCard">
        <div class="cardBody">
          <div class="kicker"><span class="kdot" aria-hidden="true"></span> ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã§ â€œãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆâ€ ã‚’ä½“é¨“ã§ãã¾ã™</div>
          <h1>èª²é¡Œä»®èª¬ã‹ã‚‰æ–½ç­–æ¡ˆã®æç¤ºã¾ã§ã€‚ã¾ãšã¯â€œãŸãŸãå°â€ã‚’1ã‚¯ãƒªãƒƒã‚¯ã§ã€‚</h1>
          <p class="sub">ç¬¬ä¸‰è€…è¦–ç‚¹ã®â€œãŸãŸãå°â€ã§æ€è€ƒã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã€‚æœ€å¾Œã®åˆ¤æ–­ã¨ç£¨ãè¾¼ã¿ã¯ã€ãƒãƒ¼ã‚±ã‚¿ãƒ¼è‡ªèº«ã§ã€‚</p>
          <div class="bullets" aria-label="ç‰¹é•·">
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸ“Œ</div>
              <div>
                <b>å…¬é–‹æƒ…å ±ã‹ã‚‰å©ãå°</b>
                <p>WEBæƒ…å ±ã‚’æ•´ç†ã—ã€èª²é¡Œã®è«–ç‚¹ã¨ä»®èª¬ã‚’ä¸‹æ›¸ãåŒ–ã—ã¾ã™ã€‚</p>
              </div>
            </div>
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸ”</div>
              <div>
                <b>å¼•ç”¨ã¨æ¨æ¸¬ã‚’æ˜ç¢ºã«</b>
                <p>å¼•ç”¨ãƒ™ãƒ¼ã‚¹ï¼AIæ¨æ¸¬ã‚’åˆ†ã‘ã¦ç¤ºã—ã€ç´å¾—æ„Ÿã‚’æ‹…ä¿ã—ã¾ã™ã€‚</p>
              </div>
            </div>
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸƒ</div>
              <div>
                <b>é‹ç”¨ã¾ã§å«ã‚ã¦ææ¡ˆ</b>
                <p>å£²ä¸ŠåŠ¹æœãƒ»è²»ç”¨ãƒ»ç¾å ´è² è·ã¾ã§æƒãˆã€å®Ÿè¡Œå¯èƒ½æ€§ã‚’é«˜ã‚ã¾ã™ã€‚</p>
              </div>
            </div>
          </div>

          <div class="heroCtas">
            <a class="btn btnPrimary" href="#trial">ğŸš€ ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«</a>
            <a class="btn btnGhost" href="#feedback">ğŸ“ è¦æœ›ãƒ•ã‚©ãƒ¼ãƒ </a>
          </div>

          <div class="note">â€»ç¾æ™‚ç‚¹ã¯ã€Œãƒªã‚¢ãƒ«æ–½è¨­ã€ã‚’å¯¾è±¡ã«ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ã‚¸ã‚¿ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ãªã©ã‚’å¯¾è±¡ã«ã—ãŸãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®æ´»ç”¨å‘ã‘ã«ã¯è€ƒæ…®å‡ºæ¥ã¦ãŠã‚Šã¾ã›ã‚“ã€‚</div>
        </div>
      </div>
    </section>

    <!-- HOW -->
    <section class="section" id="how" aria-label="ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆæ‰‹é †">
      <div class="card">
        <div class="cardHeader">
          <h2>ğŸ§© ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆæ‰‹é †</h2>
        </div>
        <div class="cardBody">
          <div class="bullets" style="margin-top:0;" aria-label="ä»•çµ„ã¿ã®æµã‚Œ">
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸ—‚ï¸</div>
              <div>
                <b>å…¬é–‹æƒ…å ±ã‚’æ•´ç†</b>
                <p>æ–½è¨­ã®ç‰¹å¾´ãƒ»æä¾›ä¾¡å€¤ãƒ»ç«¶åˆçŠ¶æ³ã‚’ã€WEBã‚µã‚¤ãƒˆãªã©ã‹ã‚‰è¦ç´„ã€‚</p>
              </div>
            </div>
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸ“Š</div>
              <div>
                <b>ç”ŸæˆAIã§èª²é¡Œä»®èª¬ã‚’ç‰¹å®š</b>
                <p>AIã§é¡§å®¢ã®æ€è€ƒã‚’ç”Ÿæˆã—ã€èª²é¡ŒãŒå¤§ãã„ã¨æ€ã‚ã‚Œã‚‹ç®‡æ‰€ã‚’ç‰¹å®šã€‚</p>
              </div>
            </div>
            <div class="bullet">
              <div class="icon" aria-hidden="true">âœ…</div>
              <div>
                <b>æœ€å„ªå…ˆæ–½ç­–ã«çµã‚‹</b>
                <p>å‘ŠçŸ¥ã‚„ç¾å ´è² è·ã¾ã§å«ã‚ã€åŠ¹æœãŒé«˜ã„æ–½ç­–ã‚’å®Ÿè¡Œå¯èƒ½ãªå½¢ã«è½ã¨ã—ã¾ã™ã€‚</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- USERS -->
    <section class="section" id="users" aria-label="æƒ³å®šåˆ©ç”¨è€…">
      <div class="card">
        <div class="cardHeader">
          <h2>ğŸ‘¥ æƒ³å®šåˆ©ç”¨è€…</h2>
        </div>
        <div class="cardBody">
          <div class="bullets" style="margin-top:0;" aria-label="æƒ³å®šåˆ©ç”¨è€…">
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸ§‘â€ğŸ’¼</div>
              <div>
                <b>æ–½è¨­ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒãƒ¼ã‚±æ‹…å½“</b>
                <p>ç¬¬ä¸‰è€…è¦–ç‚¹ã®â€œãŸãŸãå°â€ã§è«–ç‚¹ã‚’æ•´ç†ã—ã€ã‚¼ãƒ­ã‹ã‚‰è€ƒãˆãªãã¦ã‚ˆã„çŠ¶æ…‹ã«ã—ã¾ã™ã€‚</p>
              </div>
            </div>
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸ§­</div>
              <div>
                <b>äº‹æ¥­è²¬ä»»è€…ï¼æ”¯é…äºº</b>
                <p>ç¾çŠ¶ã®æ‰“ã¡æ‰‹ã‚’å‰æã«ã€ç¬¬ä¸‰è€…è¦–ç‚¹ã®æŒ‡æ‘˜ã§å„ªå…ˆé †ä½ã‚’çµ„ã¿æ›¿ãˆã‚‹â€œæ°—ã¥ãâ€ã‚’å¾—ã‚‰ã‚Œã¾ã™ã€‚</p>
              </div>
            </div>
            <div class="bullet">
              <div class="icon" aria-hidden="true">ğŸ¤</div>
              <div>
                <b>ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ”¯æ´ä¼šç¤¾</b>
                <p>ææ¡ˆå‰ã®äº‹æ¥­ç†è§£ã‚’æ•´ç†ã—ã€å·®åˆ¥åŒ–ã®è«–ç‚¹ã¨ç¢ºèªäº‹é …ã‚’æŠœã‘æ¼ã‚Œãªããã‚ãˆã¾ã™ã€‚</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PRICING -->
    <section class="section" id="pricing" aria-label="æ–™é‡‘">
      <div class="card">
        <div class="cardHeader">
          <h2>ğŸ’³ æ–™é‡‘</h2>
        </div>
        <div class="cardBody">
          <div class="pricing" aria-label="æ–™é‡‘ãƒ—ãƒ©ãƒ³">
            <div class="card priceCard">
              <div class="cardBody">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <b>ğŸ†“ ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«</b>
                  <span class="pill">ä»Šã™ã</span>
                </div>
                <div class="price">0å††</div>
                <div class="row" style="margin-top:8px;">
                  <a class="btn btnPrimary" href="#trial">ç„¡æ–™ã§è©¦ã™</a>
                </div>
              </div>
            </div>

            <div class="card priceCard">
              <div class="cardBody">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <b>â­ Proï¼ˆæº–å‚™ä¸­/è¦ç›¸è«‡ï¼‰</b>
                  <span class="pill pillSoft">ç›¸è«‡</span>
                </div>
                <div class="price">è¦ç›¸è«‡ <small>/ æœˆ</small></div>
                <div class="row" style="margin-top:8px;">
                  <a class="btn btnSoft" href="#feedback">è¦æœ›ã‚’é€ã‚‹</a>
                </div>
              </div>
            </div>
          </div>

          <div class="softNote">â€»Proãƒ—ãƒ©ãƒ³ã¯æº–å‚™ä¸­ã®ãŸã‚ã€è¦æœ›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã”ç›¸è«‡ãã ã•ã„ã€‚</div>
        </div>
      </div>
    </section>

    <!-- TRIAL + RESULT -->
    <section class="section" id="trial" aria-label="ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«">
      <div class="twoCol">
        <div class="card">
          <div class="cardHeader">
            <h2>ğŸ§ª ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ï¼ˆå‡ºåŠ›æ™‚é–“ï¼šç´„6åˆ†ï¼‰</h2>
          </div>
          <div class="cardBody">
            <label for="serviceName">ã€æ–½è¨­åãƒ»ã‚µãƒ¼ãƒ“ã‚¹åã€‘</label>
            <input id="serviceName" placeholder="ä¾‹ï¼šè¶Šè°·ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¦ãƒ³" />

            <label for="serviceUrl">ã€URLã€‘</label>
            <input id="serviceUrl" placeholder="ä¾‹ï¼šhttps://www.aeon-laketown.jp/" />

            <label for="goal">ã€èª²é¡Œãƒ»ç›®æ¨™ã€‘</label>
            <input id="goal" placeholder="ä¾‹ï¼šå¹³æ—¥ã®æ¥é¤¨è€…æ•°ã‚’å¢—ã‚„ã—ãŸã„" />

            <label for="constraints">ã€åˆ¶ç´„ã€‘</label>
            <input id="constraints" placeholder="ä¾‹ï¼šæ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ã¯é¿ã‘ã‚‹ï¼ç¾å ´è² è·ãŒéå¤§ã«ãªã‚‰ãªã„ç¯„å›²" />

            <label for="notes">ã€è£œè¶³ã€‘</label>
            <textarea id="notes" placeholder="ä¾‹ï¼šç«¶åˆã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€å­£ç¯€æ€§ï¼ˆç¹é–‘ï¼‰ã€ç›´è¿‘æ–½ç­–ãªã©"></textarea>

            <div class="row">
              <button class="btn btnPrimary" id="run">âš¡ ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ</button>
              <button class="btn btnGhost" id="fillSample">âœï¸ ã‚µãƒ³ãƒ—ãƒ«</button>
              <button class="btn btnGhost" id="clear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
            </div>

            <div class="help">
              â€»ChatGPTã®APIã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯å­¦ç¿’ã«åˆ©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚<br/>â€»å‡ºåŠ›ã«ã¯6åˆ†ç¨‹åº¦ã‹ã‹ã‚Šã¾ã™ã€‚
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>ğŸ“„ ç”Ÿæˆçµæœ</h2>
          </div>
          <div class="cardBody">
            <div class="status">
              <div class="statusLeft">
                <div class="spinner" id="spin" aria-hidden="true"></div>
                <div class="statusText" id="status">æœªå®Ÿè¡Œ</div>
              </div>
              <div class="row" style="margin:0;">
                <button class="btn btnGhost btnSmall" id="copy" disabled>â§‰ ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btnGhost btnSmall" id="downloadDoc" disabled>ğŸ“ Word</button>
</div>
            </div>

            <div class="help" style="margin:8px 0 0;">â€»å‡ºåŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã¯ã€notebookLMãªã©ã®ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆã‚µãƒ¼ãƒ“ã‚¹ã¨æ´»ç”¨ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚</div>

            <div class="resultBox">
              <div class="md" id="result">ã“ã“ã«ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            </div>
<!-- Copy fallback modal (for Google Sites embed / clipboard restrictions) -->
            <div class="copyModal" id="copyModal" aria-hidden="true">
              <div class="copyModalInner" role="dialog" aria-modal="true" aria-label="ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆ">
                <div class="copyModalHeader">
                  <div class="copyModalTitle">ğŸ“‹ ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã“ã¡ã‚‰ï¼ˆCtrl+Cã§ã‚³ãƒ”ãƒ¼ï¼‰</div>
                  <button class="btn btnGhost btnSmall" id="copyClose" type="button">é–‰ã˜ã‚‹</button>
                </div>
                <div class="copyModalBody">
                  <div class="copyHint">
                    Googleã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã§ã€Œè‡ªå‹•ã‚³ãƒ”ãƒ¼ã€ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br/>
                    ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆæ¬„ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ <b>Ctrl+A</b>ï¼ˆå…¨é¸æŠï¼‰â†’ <b>Ctrl+C</b>ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰â†’ Wordã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br/>
                    â€»Wordã§è¦‹å‡ºã—ãƒ»ç®‡æ¡æ›¸ããƒ»è¡¨ã®ä½“è£ã‚’ä¿ã¡ãŸã„å ´åˆã¯ã€ä¸Šã® <b>ğŸ“ Word</b> ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚‚ã§ãã¾ã™ã€‚
                  </div>
                  <textarea class="copyArea" id="copyArea" spellcheck="false"></textarea>
                  <div class="row" style="margin:0;">
                    <button class="btn btnSoft btnSmall" id="copySelect" type="button">Ctrl+Aï¼ˆå…¨é¸æŠï¼‰</button>
                    <button class="btn btnGhost btnSmall" id="copyPlainOnly" type="button">ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã‚³ãƒ”ãƒ¼</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- FEEDBACK (bottom) -->
    <section class="section" id="feedback" aria-label="è¦æœ›ãƒ•ã‚©ãƒ¼ãƒ ">
      <div class="card">
        <div class="cardHeader">
          <h2>ğŸ“ è¦æœ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
          <span>æ”¹å–„ã®ãŸã‚ã«ã”å”åŠ›ãã ã•ã„</span>
        </div>
        <div class="cardBody">
          <div class="callout">
            <b>ğŸ’¬ ã€Œæ¬²ã—ã„æ©Ÿèƒ½ã€ã‚„ã€Œä½¿ã„ã«ãã„ç‚¹ã€ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</b>
            <p>å›ç­”ã¯2ã€œ3åˆ†ã§å®Œäº†ã—ã¾ã™ã€‚ã„ãŸã ã„ãŸå†…å®¹ã‚’å‚è€ƒã«ã—ã¦é †æ¬¡æ”¹å–„ã—ã¾ã™ã€‚</p>
          </div>

          <div class="row" style="margin-top:12px;">
            <a
              class="btn btnPrimary"
              href="https://forms.gle/z54TfgfK1o2f5NfC6">ğŸ”— è¦æœ›ãƒ•ã‚©ãƒ¼ãƒ ã¸ï¼ˆåˆ¥ã‚¿ãƒ–ï¼‰</a>
          </div>

          <div class="help" style="margin-top:10px;">â€»ãƒ•ã‚©ãƒ¼ãƒ ã¯åˆ¥ãƒšãƒ¼ã‚¸ã§é–‹ãã¾ã™ã€‚</div>

          <footer class="footer" style="margin-top:16px;">
            Â© Marketing Issues Draft
          </footer>
        </div>
      </div>
    </section>
  </main>

  <script>
  /**
   * Difyé€£æºï¼ˆå®‰å…¨ç‰ˆï¼‰
   * - ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰Dify API Keyã‚’æ‰±ã‚ãªã„ãŸã‚ã€GASä¸­ç¶™ï¼ˆProxyï¼‰ã‚’å©ãã¾ã™
   * - GASãŒ Dify /v1/workflows/runï¼ˆblockingï¼‰ã‚’å‘¼ã³ã€çµæœJSONã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™
   */
  /* âš ï¸ PoCæœ€çŸ­ï¼šDify APIã‚­ãƒ¼ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚
     å¤–éƒ¨å…¬é–‹ã‚„ç¬¬ä¸‰è€…åˆ©ç”¨ã®ç”¨é€”ã§ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ï¼ˆã‚­ãƒ¼ãŒæ¼ã‚Œã¾ã™ï¼‰ã€‚ */
  const DIFY_API_KEY = "app-aJCOlDgIOF6bq4NpQX9hNs1A";
  const DIFY_RUN_URL = "https://api.dify.ai/v1/workflows/run";

  // Elements
  const runBtn = document.getElementById("run");
  const spin = document.getElementById("spin");
  const statusEl = document.getElementById("status");
  const resultEl = document.getElementById("result");
  const copyBtn = document.getElementById("copy");
  const docBtn = document.getElementById("downloadDoc");
  const pdfBtn = document.getElementById("downloadPdf");

  // Copy fallback modal
  const copyModal = document.getElementById("copyModal");
  const copyArea = document.getElementById("copyArea");
  const copyCloseBtn = document.getElementById("copyClose");
  const copySelectBtn = document.getElementById("copySelect");
  const copyPlainOnlyBtn = document.getElementById("copyPlainOnly");

  window.addEventListener("DOMContentLoaded", () => {
    // Inputs
    const serviceNameEl = document.getElementById("serviceName");
    const serviceUrlEl = document.getElementById("serviceUrl");
    const goalEl = document.getElementById("goal");
    const constraintsEl = document.getElementById("constraints");
    const notesEl = document.getElementById("notes");

    // State
    let lastMarkdown = "";
    let lastHtml = "";
    let lastPdfUrl = "";

    function setLoading(isLoading) {
      spin.style.display = isLoading ? "block" : "none";
      runBtn.disabled = isLoading;
      runBtn.textContent = isLoading ? "ç”Ÿæˆä¸­..." : "âš¡ ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ";
    }

    function extractFirstHttpUrl(s) {
      if (typeof s !== "string") return null;
      const m = s.match(/https?:\/\/[^\s'"\]\}<>]+/i);
      return m ? m[0] : null;
    }

    function fixAnchorsToHttp(container) {
      const anchors = container.querySelectorAll("a[href]");
      anchors.forEach((a) => {
        const href = a.getAttribute("href") || "";
        // æ–‡å­—åˆ—åŒ–ã•ã‚ŒãŸé…åˆ—/è¾æ›¸ãŒãƒªãƒ³ã‚¯æ‰±ã„ã«ãªã‚Š file:/// ã«è§£æ±ºã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã‚’æ•‘æ¸ˆ
        // href ã¾ãŸã¯è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ https URL ã‚’æŠ½å‡ºã—ã¦å·®ã—æ›¿ãˆã‚‹
        const url = extractFirstHttpUrl(href) || extractFirstHttpUrl(a.textContent || "");
        if (url) {
          a.setAttribute("href", url);
          a.setAttribute("target", "_blank");
          a.setAttribute("rel", "noopener noreferrer");
        }
      });
    }

    function normalizePdfUrl(v) {
      if (v == null) return "";
      if (typeof v === "object") {
        try {
          v = v.url || v.link || JSON.stringify(v);
        } catch (_) {
          v = String(v);
        }
      }
      const s = String(v);
      return extractFirstHttpUrl(s) || s;
    }

    function renderMarkdown(md) {
      marked.setOptions({ breaks: true });
      resultEl.innerHTML = marked.parse(md || "");
      fixAnchorsToHttp(resultEl);
      lastHtml = resultEl.innerHTML || "";
    }

    function getOrCreateUserId() {
      const key = "fgi_user_id";
      const existing = localStorage.getItem(key);
      if (existing) return existing;

      const id =
        window.crypto && crypto.randomUUID
          ? "web-" + crypto.randomUUID()
          : "web-" + String(Date.now());

      localStorage.setItem(key, id);
      return id;
    }

    function buildInputs() {
      const service_name = (serviceNameEl.value || "").trim();
      const url = (serviceUrlEl.value || "").trim();
      const assumed_issue = (goalEl.value || "").trim(); // Startãƒãƒ¼ãƒ‰: assumed_issue
      const message = (notesEl.value || "").trim(); // Startãƒãƒ¼ãƒ‰: message
      const constraints = (constraintsEl.value || "").trim();

      return { service_name, url, assumed_issue, message, constraints };
    }

    // Sample input
    document.getElementById("fillSample").addEventListener("click", () => {
      serviceNameEl.value = "è¶Šè°·ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¦ãƒ³";
      serviceUrlEl.value = "https://www.aeon-laketown.jp/";
      goalEl.value = "å¹³æ—¥ã®æ¥é¤¨è€…æ•°ã‚’å¢—ã‚„ã—ãŸã„";
      constraintsEl.value = "æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ã¯é¿ã‘ã‚‹ï¼ç¾å ´è² è·ãŒéå¤§ã«ãªã‚‰ãªã„ç¯„å›²";
      notesEl.value = "ç«¶åˆã¨ã®å·®åˆ¥åŒ–ã‚’æ˜ç¢ºã«ã—ãŸã„ã€‚";
    });

    // Clear
    document.getElementById("clear").addEventListener("click", () => {
      serviceNameEl.value = "";
      serviceUrlEl.value = "";
      goalEl.value = "";
      constraintsEl.value = "";
      notesEl.value = "";
    });

    // ===== Copy (Word-friendly: HTML + text) =====
    function showCopyModal(text) {
      if (!copyModal || !copyArea) return;
      copyArea.value = text || "";
      copyModal.style.display = "flex";
      copyModal.setAttribute("aria-hidden", "false");

      setTimeout(() => {
        try {
          copyArea.focus();
          copyArea.select();
        } catch (_) {}
      }, 50);
    }

    function hideCopyModal() {
      if (!copyModal) return;
      copyModal.style.display = "none";
      copyModal.setAttribute("aria-hidden", "true");
    }

    if (copyCloseBtn) {
      copyCloseBtn.addEventListener("click", hideCopyModal);
    }

    if (copyModal) {
      // click backdrop to close
      copyModal.addEventListener("click", (e) => {
        if (e.target === copyModal) hideCopyModal();
      });
    }

    if (copySelectBtn) {
      copySelectBtn.addEventListener("click", () => {
        try {
          copyArea.focus();
          copyArea.select();
        } catch (_) {}
      });
    }

    async function copyPlainAsync(text) {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text || "");
          return true;
        }
      } catch (_) {}

      try {
        const ta = document.createElement("textarea");
        ta.value = text || "";
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return !!ok;
      } catch (_) {
        return false;
      }
    }

    async function copyRichAsync(html, text) {
      // Try modern Clipboard API with HTML (best for Word paste)
      try {
        if (navigator.clipboard && window.ClipboardItem) {
          const item = new ClipboardItem({
            "text/html": new Blob([html || ""], { type: "text/html" }),
            "text/plain": new Blob([text || ""], { type: "text/plain" }),
          });
          await navigator.clipboard.write([item]);
          return true;
        }
      } catch (_) {}

      // Fallback: execCommand copy (often works even when clipboard API is blocked in iframes)
      try {
        const container = document.createElement("div");
        container.style.position = "fixed";
        container.style.left = "-9999px";
        container.style.top = "0";
        container.style.width = "1px";
        container.style.height = "1px";
        container.style.opacity = "0";
        container.innerHTML = html || "";
        document.body.appendChild(container);

        const range = document.createRange();
        range.selectNodeContents(container);

        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);

        const ok = document.execCommand("copy");
        sel.removeAllRanges();
        container.remove();

        if (ok) return true;
      } catch (_) {}

      // Last resort: plain text
      return await copyPlainAsync(text || "");
    }

    copyBtn.addEventListener("click", async () => {
      const ok = await copyRichAsync(lastHtml || "", lastMarkdown || "");
      if (ok) {
        statusEl.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆWordè²¼ã‚Šä»˜ã‘ï¼‰";
        setTimeout(() => (statusEl.textContent = "å®Œäº†"), 1200);
      } else {
        statusEl.textContent = "ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆæ‰‹å‹•ã‚³ãƒ”ãƒ¼ã«åˆ‡æ›¿ï¼‰";
        showCopyModal(lastMarkdown || "");
      }
    });

    if (copyPlainOnlyBtn) {
      copyPlainOnlyBtn.addEventListener("click", async () => {
        const ok = await copyPlainAsync(copyArea ? copyArea.value : lastMarkdown || "");
        statusEl.textContent = ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰" : "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ";
      });
    }

    // ===== Word Download =====
    function safeFileName(name) {
      return (
        String(name || "report")
          .replace(/[\\\/:*?"<>|]/g, "_")
          .replace(/\s+/g, " ")
          .trim()
          .slice(0, 60) || "report"
      );
    }

    function timeStamp() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(
        d.getMinutes()
      )}`;
    }

    function escapeHtml(s) {
      return String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function buildWordHtml(title, bodyHtml) {
      // Wordã¯HTMLã‚’èª­ã¿è¾¼ã‚ã¾ã™ï¼ˆ.docæ‹¡å¼µå­ã§ã‚‚OKï¼‰
      return `<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>${escapeHtml(title)}</title>
<style>
  body{
    font-family: "Meiryo", "Yu Gothic", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    font-size: 11pt;
    line-height: 1.6;
    color: #0f172a;
    margin: 24px;
  }
  h1,h2,h3{ margin: 14px 0 10px; }
  table{ border-collapse: collapse; width: 100%; }
  th, td{ border: 1px solid #d1d5db; padding: 8px; vertical-align: top; }
  th{ background: #f1f5f9; }
  a{ color: #2563eb; }
  code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 10pt; }
  pre{ white-space: pre-wrap; }
</style>
</head>
<body>
${bodyHtml || ""}
</body>
</html>`;
    }

    function downloadWordDoc() {
      const body = lastHtml || "";
      if (!body) {
        statusEl.textContent = "å‡ºåŠ›ãŒã‚ã‚Šã¾ã›ã‚“";
        return;
      }

      const filename = `${safeFileName(serviceNameEl.value)}_${timeStamp()}.doc`;
      const html = buildWordHtml(filename, body);
      const blob = new Blob([html], { type: "application/msword" });
      const objectUrl = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = objectUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
    }

    if (docBtn) {
      docBtn.addEventListener("click", downloadWordDoc);
    }

    // ===== PDF Download (button may be absent) =====
    async function downloadPdf(url) {
      url = normalizePdfUrl(url);

      const originalText = pdfBtn ? pdfBtn.textContent : "";
      try {
        if (pdfBtn) pdfBtn.disabled = true;
        if (pdfBtn) pdfBtn.textContent = "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­â€¦";

        // å¯èƒ½ãªã‚‰blobå–å¾—ã—ã¦â€œä¿å­˜â€ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const res = await fetch(url, { mode: "cors" });
        if (!res.ok) throw new Error("fetch failed");
        const blob = await res.blob();

        const filename = `${safeFileName(serviceNameEl.value)}_${timeStamp()}.pdf`;
        const objectUrl = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = objectUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
      } catch (e) {
        // CORSç­‰ã§blobå–å¾—ã§ããªã„å ´åˆã¯ã€æ–°è¦ã‚¿ãƒ–ã§é–‹ãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿å­˜ã§ãã‚‹ï¼‰
        window.location.href = url;
      } finally {
        if (pdfBtn) pdfBtn.textContent = originalText;
        if (pdfBtn) pdfBtn.disabled = !lastPdfUrl;
      }
    }

    if (pdfBtn) {
      pdfBtn.addEventListener("click", () => {
        if (!lastPdfUrl) {
          statusEl.textContent = "PDF URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
          return;
        }
        downloadPdf(lastPdfUrl);
      });
    }

    // ===== Dify API (start -> poll) =====
    async function startRunGetId(inputs, userId) {
      if (!DIFY_API_KEY || DIFY_API_KEY === "PASTE_YOUR_DIFY_API_KEY_HERE") {
        throw new Error("Dify APIã‚­ãƒ¼ãŒæœªè¨­å®šã§ã™ã€‚HTMLå†…ã® DIFY_API_KEY ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
      }

      const res = await fetch(DIFY_RUN_URL, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${DIFY_API_KEY}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          inputs,
          response_mode: "streaming",
          user: userId,
        }),
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`Dify start error (HTTP ${res.status})\n${t.slice(0, 400)}`);
      }

      // SSE ã‚’å°‘ã—ã ã‘èª­ã‚€ï¼ˆworkflow_run_id ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buf = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buf += decoder.decode(value, { stream: true });

        const m = buf.match(/"workflow_run_id"\s*:\s*"([^"]+)"/);
        if (m) {
          // ã“ã“ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨ã€ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ç”Ÿæˆè‡ªä½“ãŒé€”ä¸­ã§æ­¢ã¾ã‚Šã€
          // outputs.markdown ãŒã€Œé€”ä¸­ã§é€”åˆ‡ã‚Œã‚‹ã€ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
          // ãã®ãŸã‚ã€IDã‚’å–å¾—ã—ãŸã‚‰â€œãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èª­ã¿åˆ‡ã£ã¦â€æ¥ç¶šã‚’è‡ªç„¶çµ‚äº†ã•ã›ã¾ã™ï¼ˆç”Ÿæˆã¯ç¶™ç¶šï¼‰ã€‚
          (async () => {
            try {
              while (true) {
                const r = await reader.read();
                if (r.done) break;
              }
            } catch (_) {}
          })();

          return m[1];
        }

        if (buf.length > 20000) buf = buf.slice(-10000);
      }

      throw new Error("workflow_run_id ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆSSEã‹ã‚‰è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰ã€‚");
    }

    async function pollRunDetail(runId) {
      const res = await fetch(`${DIFY_RUN_URL}/${encodeURIComponent(runId)}`, {
        method: "GET",
        headers: { Authorization: `Bearer ${DIFY_API_KEY}` },
      });

      const t = await res.text();
      let j;
      try {
        j = t ? JSON.parse(t) : {};
      } catch (_) {
        throw new Error(`Dify poll non-JSON (HTTP ${res.status})\n${t.slice(0, 200)}`);
      }

      if (!res.ok) {
        throw new Error(`Dify poll error (HTTP ${res.status})\n${t.slice(0, 400)}`);
      }

      return j;
    }

    // ===== Run =====
    runBtn.addEventListener("click", async () => {
      const inputs = buildInputs();

      // å¿…é ˆãƒã‚§ãƒƒã‚¯
      if (!inputs.service_name) {
        statusEl.textContent = "ã€æ–½è¨­åãƒ»ã‚µãƒ¼ãƒ“ã‚¹åã€‘ã¯å¿…é ˆã§ã™";
        return;
      }

      lastMarkdown = "";
      lastHtml = "";
      lastPdfUrl = "";
      copyBtn.disabled = true;
      if (docBtn) docBtn.disabled = true;
      if (pdfBtn) pdfBtn.disabled = true;

      setLoading(true);
      statusEl.textContent = "é–‹å§‹ä¸­â€¦";
      resultEl.textContent = "ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚çµæœã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦";

      const userId = getOrCreateUserId();

      try {
        // 1) startï¼ˆrun_id ã‚’å–å¾—ï¼šã“ã“ã§ã¯ workflow_run_idï¼‰
        const runId = await startRunGetId(inputs, userId);

        statusEl.textContent = "å®Ÿè¡Œä¸­â€¦";
        resultEl.textContent = "å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚å®Œäº†ã¾ã§6åˆ†ç¨‹åº¦ï¼ˆ360ssï¼‰ãŠå¾…ã¡ãã ã•ã„â€¦";

        // 2) pollï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
        const startedAt = Date.now();
        let waitMs = 2000;
        const maxWaitMs = 15000;
        const hardTimeoutMs = 10 * 60 * 1000; // 10åˆ†

        while (true) {
          const elapsed = Date.now() - startedAt;

          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          if (elapsed > hardTimeoutMs) {
            throw new Error(
              "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šå®Ÿè¡ŒãŒé•·æ™‚é–“å®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚Difyãƒ­ã‚°ã§è©²å½“å®Ÿè¡Œã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            );
          }

          // å°‘ã—å¾…ã¤
          await new Promise((r) => setTimeout(r, waitMs));

          const pollResp = await pollRunDetail(runId);

          // pollResp ã¯ Dify ã®ã€Œå®Ÿè¡Œè©³ç´°ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆå½¢å¼ãŒç’°å¢ƒã§ç•°ãªã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚æ­£è¦åŒ–ï¼‰
          const detail =
            pollResp && typeof pollResp === "object" && pollResp.data && typeof pollResp.data === "object"
              ? pollResp.data
              : pollResp;

          const status = detail && detail.status ? detail.status : "";
          let outputs = detail && Object.prototype.hasOwnProperty.call(detail, "outputs") ? detail.outputs : {};

          // outputs ãŒ JSONæ–‡å­—åˆ—ã§è¿”ã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆä¾‹: "{\"markdown\":\"...\"}"ï¼‰ã«å¯¾å¿œ
          if (typeof outputs === "string") {
            const trimmed = outputs.trim();
            if (
              (trimmed.startsWith("{") && trimmed.endsWith("}")) ||
              (trimmed.startsWith("[") && trimmed.endsWith("]"))
            ) {
              try {
                outputs = JSON.parse(outputs);
              } catch (_) {}
            }
          }

          if (outputs == null) outputs = {};

          const errMsg =
            detail && detail.error ? detail.error : pollResp && pollResp.error ? pollResp.error : "";

          const s = String(status || "").toLowerCase();
          const runningStates = new Set(["running", "pending", "queued", "processing", "started", "in_progress"]);
          const successStates = new Set(["succeeded", "completed", "success", "done", "finished"]);
          const failStates = new Set(["failed", "error", "stopped", "cancelled", "canceled", "timeout"]);

          if (runningStates.has(s) || !s) {
            const sec = Math.floor(elapsed / 1000);
            statusEl.textContent = `å®Ÿè¡Œä¸­â€¦ï¼ˆ${sec}sï¼‰`;
            waitMs = Math.min(Math.round(waitMs * 1.35), maxWaitMs);
            continue;
          }

          if (successStates.has(s)) {
            let md = "";
            let pdf = "";

            if (typeof outputs === "string") {
              md = outputs;
            } else if (outputs && typeof outputs === "object") {
              md = outputs.markdown || outputs.text || outputs.result || outputs.output || outputs.content || "";
              pdf = outputs.pdf_url || outputs.pdf || outputs.pdfUrl || "";
            }

            // ã¾ã‚Œã« outputs ãŒ detail ç›´ä¸‹ã§ã¯ãªãåˆ¥ã‚­ãƒ¼ã«å…¥ã‚‹ã‚±ãƒ¼ã‚¹ã‚‚æ‹¾ã†
            if (!md) {
              const alt = detail && typeof detail === "object" ? detail.markdown || detail.text || detail.result : "";
              if (typeof alt === "string") md = alt;
            }

            if (!pdf) {
              const altPdf = detail && typeof detail === "object" ? detail.pdf_url || detail.pdf : "";
              if (typeof altPdf === "string") pdf = altPdf;
            }

            pdf = normalizePdfUrl(pdf);

            // å¿µã®ãŸã‚ï¼šstatusãŒsucceededã§ã‚‚ outputs ãŒé…å»¶æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
            // å°‘ã—é•·ã‚ã«å†å–å¾—ã—ã¦ã€Œæœ€ã‚‚é•·ã„ markdownã€ã‚’æ¡ç”¨
            try {
              let bestMd = typeof md === "string" ? md : "";
              let bestPdf = typeof pdf === "string" ? pdf : "";
              let same = 0;

              for (let i = 0; i < 25; i++) {
                await new Promise((r) => setTimeout(r, 1200));
                const pollResp2 = await pollRunDetail(runId);

                const detail2 =
                  pollResp2 &&
                  typeof pollResp2 === "object" &&
                  pollResp2.data &&
                  typeof pollResp2.data === "object"
                    ? pollResp2.data
                    : pollResp2;

                let outputs2 =
                  detail2 && Object.prototype.hasOwnProperty.call(detail2, "outputs") ? detail2.outputs : {};

                if (typeof outputs2 === "string") {
                  const trimmed2 = outputs2.trim();
                  if (
                    (trimmed2.startsWith("{") && trimmed2.endsWith("}")) ||
                    (trimmed2.startsWith("[") && trimmed2.endsWith("]"))
                  ) {
                    try {
                      outputs2 = JSON.parse(outputs2);
                    } catch (_) {}
                  }
                }

                if (outputs2 == null) outputs2 = {};

                let md2 = "";
                let pdf2 = "";

                if (typeof outputs2 === "string") {
                  md2 = outputs2;
                } else if (outputs2 && typeof outputs2 === "object") {
                  md2 = outputs2.markdown || outputs2.text || outputs2.result || outputs2.output || outputs2.content || "";
                  pdf2 =
                    outputs2.pdf_url ||
                    outputs2.pdf ||
                    outputs2.pdfUrl ||
                    outputs2.pdf_link ||
                    outputs2.pdfLink ||
                    "";
                }

                if (!md2) {
                  const alt2 =
                    detail2 && typeof detail2 === "object" ? detail2.markdown || detail2.text || detail2.result : "";
                  if (typeof alt2 === "string") md2 = alt2;
                }

                if (!pdf2) {
                  const altPdf2 = detail2 && typeof detail2 === "object" ? detail2.pdf_url || detail2.pdf : "";
                  if (typeof altPdf2 === "string") pdf2 = altPdf2;
                }

                if (md2 && md2.length > bestMd.length) {
                  bestMd = md2;
                  same = 0;
                } else {
                  same += 1;
                }

                if (!bestPdf && pdf2) bestPdf = pdf2;

                // ä¸€å®šå›æ•°é€£ç¶šã§ä¼¸ã³ãªã„ãªã‚‰ååˆ†ã¨ã¿ãªã—ã¦æ‰“ã¡åˆ‡ã‚Š
                if (same >= 8) break;
              }

              md = bestMd;
              if (!pdf && bestPdf) pdf = bestPdf;
            } catch (_) {}

            lastMarkdown = md;
            lastPdfUrl = normalizePdfUrl(pdf);

            if (md || pdf) {
              renderMarkdown(md || "ï¼ˆPDFã®ã¿ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼‰");
            } else {
              // ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ã‚ˆã†ã€å–å¾—ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãã®ã¾ã¾è¡¨ç¤º
              const raw = JSON.stringify(detail, null, 2);
              renderMarkdown(
                "ï¼ˆå‡ºåŠ›ãŒç©ºã§ã—ãŸã€‚Difyã®å‡ºåŠ›ãƒãƒ¼ãƒ‰ã§ `markdown` / `pdf_url` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰\n\n" +
                  "---\n\n" +
                  "### ãƒ‡ãƒãƒƒã‚°ï¼šå–å¾—ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚³ãƒ”ãƒšç”¨ï¼‰\n" +
                  "```json\n" +
                  raw +
                  "\n```"
              );
            }

            copyBtn.disabled = !md;
            if (docBtn) docBtn.disabled = !md;
            if (pdfBtn) pdfBtn.disabled = !lastPdfUrl;

            statusEl.textContent = "å®Œäº†";
            break;
          }

          if (failStates.has(s)) {
            throw new Error(
              `Difyå®Ÿè¡ŒãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆstatus: ${status}ï¼‰\n${(errMsg || "ï¼ˆã‚¨ãƒ©ãƒ¼è©³ç´°ãªã—ï¼‰").slice(0, 1400)}`
            );
          }

          // æƒ³å®šå¤–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šè¡¨ç¤ºã—ã¦ç¶™ç¶š
          const sec = Math.floor(elapsed / 1000);
          statusEl.textContent = `å®Ÿè¡Œä¸­â€¦ï¼ˆ${sec}s / status: ${status}ï¼‰`;
          waitMs = Math.min(Math.round(waitMs * 1.35), maxWaitMs);
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ã‚¨ãƒ©ãƒ¼";

        const msg = err && err.message ? err.message : String(err);
        resultEl.textContent =
          `ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼š\n${msg}\n\nç¢ºèªãƒã‚¤ãƒ³ãƒˆï¼š\n` +
          "ãƒ»HTMLå†…ã® DIFY_API_KEY ãŒæ­£ã—ã„ã‹ï¼ˆè²¼ã‚Šä»˜ã‘æ¸ˆã¿ã‹ï¼‰\n" +
          "ãƒ»Dify Endãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ãŒ markdown / pdf_url ã«ãªã£ã¦ã„ã‚‹ã‹\n" +
          "ãƒ»Difyãƒ­ã‚°ã§è©²å½“å®Ÿè¡ŒãŒ running ã®ã¾ã¾è©°ã¾ã£ã¦ã„ãªã„ã‹\n" +
          "ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆToo many requestsï¼‰ãŒå‡ºã¦ã„ãªã„ã‹ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ä¸Šã’ã‚‹ï¼‰\n" +
          "ãƒ»ã‚‚ã— Console ã« CORS ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆï¼šãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰Difyã¸ç›´æ¥ã¯ä¸å¯ï¼ˆPoCæ‰‹æ®µã‚’åˆ‡æ›¿ãŒå¿…è¦ï¼‰";
      } finally {
        setLoading(false);
      }
    });
  });
</script>


<script>
/**
 * Google Sites ã®åŸ‹ã‚è¾¼ã¿(iframe)ã§ã¯ã€href="#..." ã®é·ç§»ãŒæ–°è¦ã‚¿ãƒ–ã§é–‹ã‹ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
 * ãã®ãŸã‚ã€ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯ã¯ã€Œé·ç§»ã€ã›ãšã« JS ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚
 */
(function () {
  const HEADER_SELECTOR = '.nav';
  const getHeaderOffset = () => {
    const h = document.querySelector(HEADER_SELECTOR);
    if (!h) return 0;
    // +8px ä½™ç™½ã§è¦‹åˆ‡ã‚Œé˜²æ­¢
    return Math.ceil(h.getBoundingClientRect().height) + 8;
  };

  const scrollToId = (id) => {
    const el = document.getElementById(id);
    if (!el) return;
    const offset = getHeaderOffset();
    const y = window.scrollY + el.getBoundingClientRect().top - offset;
    window.scrollTo({ top: Math.max(0, y), behavior: 'smooth' });
  };

  // ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯(#...)ã‚’æ•æ‰ã—ã¦ã€Œé·ç§»ã€ã‚’æ­¢ã‚ã‚‹
  document.addEventListener('click', function (e) {
    const a = e.target.closest && e.target.closest('a[href^="#"]');
    if (!a) return;
    const href = a.getAttribute('href');
    if (!href || href === '#') return;
    const id = href.slice(1);
    e.preventDefault();
    scrollToId(id);
  }, true);

  // åˆæœŸè¡¨ç¤ºã§URLã«#ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆåŸ‹ã‚è¾¼ã¿æ™‚ã¯åŠ¹ã‹ãªã„ã“ã¨ã‚‚ã‚ã‚‹ãŒå®‰å…¨ï¼‰
  window.addEventListener('load', function () {
    const hash = (location.hash || '').replace('#', '');
    if (hash) scrollToId(hash);
  });
})();
</script>

</body>
</html>
